---
title: "Rate models"
author: "Geir Bolstad"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r, eval = FALSE}

# testing:
tree <- geiger::sim.bdtree(b = 1, d = 0, n = 100, t = 4)
tree$edge.length <- tree$edge.length/diag(ape::vcv(tree))[1]

mod <- rate_sim(tree, startv_x=3, sigma_x=1, a= 0.001, b=1)

mod$x + rnorm(length(mod$x))


rate_gls(x=mod$x, y=mod$y, tree, model = "residual_rate", Beta = as.matrix(c(mean(y^2), 0)), sigma_y = NULL, maxiter = 100, silent = FALSE)



A <-ape::vcv(tree)
C <- t(chol(A))
R <- diag(ncol(A))*1

sigma_x <- var(solve(C)%*%mod$x)

Ainv <- solve(A)
Rinv <- solve(R)

x1 <- solve(C)%*%(mod$x-mean(mod$x))
x2 <- solve(Rinv+solve(c(sigma_x)*A))%*%Rinv%*%(mod$x-mean(mod$x))
x3 <- (A-solve(diag(x = diag(Ainv))))%*%Ainv%*%(mod$x-mean(mod$x))
x4 <- A%*%solve(A+R)%*%(mod$x-mean(mod$x))
  
plot(x2, x4)
plot(mod$x, x4)
  
plot(solve(C)%*%mod$x, solve(Rinv+solve(c(sigma_x)*A))%*%Rinv%*%(mod$x-mean(mod$x)))

plot(solve(C)%*%mod$x, (A-solve(diag(x = diag(Ainv))))%*%Ainv%*%(mod$x-mean(mod$x)))





```

