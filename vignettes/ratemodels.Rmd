---
title: "Rate models"
author: "Geir Bolstad"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


```{r, eval = FALSE}

# testing:
tree <- geiger::sim.bdtree(b = 1, d = 0, n = 100, t = 4)
tree$edge.length <- tree$edge.length/diag(ape::vcv(tree))[1]

mod <- rate_sim(tree, startv_x=3, sigma_x=1, a= 0.001, b=1, model = "predictor_geometricBM")

#mod$y <- mod$y + rnorm(length(mod$y))


rate_gls(x=mod$x, y=mod$y, species=tree$tip.label, tree, model = "predictor_geometricBM", maxiter = 100, silent = FALSE)



A <-ape::vcv(tree)
C <- t(chol(A))
R <- diag(ncol(A))*1

sigma_x <- var(solve(C)%*%mod$x)

Ainv <- solve(A)
Rinv <- solve(R)

x1 <- solve(C)%*%(mod$x-mean(mod$x))
x2 <- solve(Rinv+solve(c(sigma_x)*A))%*%Rinv%*%(mod$x-mean(mod$x))
x3 <- (A-solve(diag(x = diag(Ainv))))%*%Ainv%*%(mod$x-mean(mod$x))
x4 <- A%*%solve(A+R)%*%(mod$x-mean(mod$x))
  
plot(x2, x4)
plot(mod$x, x4)
  
plot(solve(C)%*%mod$x, solve(Rinv+solve(c(sigma_x)*A))%*%Rinv%*%(mod$x-mean(mod$x)))

plot(solve(C)%*%mod$x, (A-solve(diag(x = diag(Ainv))))%*%Ainv%*%(mod$x-mean(mod$x)))


#### testing almer
tree <- geiger::sim.bdtree(b = 1, d = 0, n = 100, t = 4)
tree$edge.length <- tree$edge.length/diag(ape::vcv(tree))[1]
mod <- rate_sim(tree, startv_x=3, sigma_x=1, a= 0.001, b=1)
A <- Matrix::Matrix(ape::vcv(tree), sparse = TRUE)
#A <- as(A, "dgCMatrix")
# colnames(A) <- paste("q", 1:100)
# rownames(A) <- paste("q", 1:100)
dt <- data.frame(species = paste("s", mod$species, sep = ""),
                 x = mod$x)

Almer(formula = x ~ 1 + (1|species), data = dt, A = list(species = A))
A <- A[100-0:99, 100-0:99]
Almer(formula = x ~ 1 + (1|species), data = dt, A = list(species = A))

mod <- Almer(formula = x ~ 1 + (1|species), data = dt, A = list(species = A))


##### residual rate simulation #####
b_true <- (1:100)/20
b_est <- NA
for(i in 1:length(b_true)){
  n <- 200
  tree <- geiger::sim.bdtree(b = 1, d = 0, n = n, t = 4)
  tree$edge.length <- tree$edge.length/diag(ape::vcv(tree))[1]
  
  x <- exp(rnorm(n))
  
  dt <- rate_sim(tree, a = 1, b = b_true[i], x = x, model = "residual_rate")
  mod <- rate_gls(x=dt$x, y=dt$y, species=dt$species, tree, model = "residual_rate", maxiter = 100, silent = FALSE, 
                      startv = list(a=NULL, b=NULL))
  if(mod$convergence == "Convergence") b_est[i] <- mod$param["b", 1]
  else b_est[i] <- NA
  
}

plot(b_true, b_est)
abline(0,1)
abline(lm(b_est~b_true[1:length(b_est)]))

warnings()


```


